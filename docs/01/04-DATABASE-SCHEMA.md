# 02 - Database Schema Design

## ðŸ—„ï¸ Entity Relationship Diagram

```mermaid
erDiagram
    profiles ||--o{ user_roles : has
    profiles ||--o{ ai_conversations : creates
    profiles ||--o{ ai_events : organizes
    ai_conversations ||--o{ ai_messages : contains
    ai_events ||--o{ ai_tasks : generates
    ai_events ||--o{ tickets : offers
    tickets ||--o{ orders : purchased_via
    orders ||--o{ attendees : includes
    
    profiles {
        uuid id PK
        uuid user_id FK
        text full_name
        text email
        text avatar_url
        text company_name
        timestamp created_at
    }
    
    user_roles {
        uuid id PK
        uuid user_id FK
        app_role role
        timestamp created_at
    }
    
    ai_conversations {
        uuid id PK
        uuid user_id FK
        text title
        jsonb metadata
        timestamp created_at
    }
    
    ai_messages {
        uuid id PK
        uuid conversation_id FK
        text role
        text content
        jsonb tool_calls
        timestamp created_at
    }
    
    ai_events {
        uuid id PK
        uuid organizer_id FK
        text name
        text slug
        jsonb landing_page_config
        timestamp start_date
        timestamp end_date
        text status
        timestamp created_at
    }
    
    ai_tasks {
        uuid id PK
        uuid event_id FK
        text type
        text status
        jsonb data
        timestamp due_date
    }
    
    tickets {
        uuid id PK
        uuid event_id FK
        text name
        numeric price
        integer quantity
        integer sold
        timestamp created_at
    }
    
    orders {
        uuid id PK
        uuid event_id FK
        uuid customer_id FK
        numeric total_amount
        text stripe_payment_intent
        text status
        timestamp created_at
    }
    
    attendees {
        uuid id PK
        uuid order_id FK
        uuid ticket_id FK
        jsonb attendee_info
        text qr_code
        boolean checked_in
    }
```

## ðŸ” Security Model

```mermaid
graph LR
    subgraph "Authentication"
        User[Authenticated User]
        Anon[Anonymous User]
    end
    
    subgraph "Authorization - RBAC"
        Admin[Admin Role]
        Organizer[Organizer Role]
        Attendee[Attendee Role]
    end
    
    subgraph "Row Level Security"
        OwnData[Own Data Only]
        OrgData[Organization Data]
        PublicData[Public Data]
    end
    
    User --> Admin
    User --> Organizer
    User --> Attendee
    
    Admin --> OrgData
    Organizer --> OwnData
    Attendee --> OwnData
    Anon --> PublicData
```

## ðŸ“Š Core Tables

### Security & Identity
- **profiles**: User profile information (auto-created via trigger)
- **user_roles**: RBAC implementation (admin, organizer, attendee)
- **audit_logs**: Security audit trail

### AI Conversation Layer
- **ai_conversations**: Chat sessions between user and AI
- **ai_messages**: Individual messages with tool calls
- **ai_events**: Events created through AI interaction
- **ai_tasks**: Automated tasks generated by AI

### Event Management
- **tickets**: Ticket types and pricing
- **orders**: Payment transactions
- **attendees**: Registered participants
- **email_templates**: Customizable email templates

### System
- **rate_limits**: API rate limiting tracking
- **storage buckets**: File storage for landing pages/images

## ðŸ”‘ Key Design Decisions

1. **No direct auth.users references**: Always use `profiles(id)` in RLS policies
2. **SECURITY DEFINER functions**: For role checks to avoid RLS recursion
3. **JSONB for flexibility**: `landing_page_config`, `metadata` for AI-generated content
4. **GIN indexes**: On all JSONB columns for performance
5. **Explicit CASCADE**: Define per FK (CASCADE for messages, RESTRICT for payments)
6. **Auto-timestamps**: Triggers on all tables with `updated_at`
